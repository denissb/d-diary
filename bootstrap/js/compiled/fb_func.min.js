var loading_queue=0;$("#fbLogin").click(function(){fb_login()});$("#unlink_button").click(function(){if(confirm(ui_lang.facebook_unlink))window.location="http://ddiary.loc/logout/app/unlink";else return!1});$("#addWidgets").click(function(){if($("#widget_settings").data("changed")){var a=$("#widget_settings");a.attr("action",config.home+"settings/process_widgets");a.submit()}else $("#widget_settings").response(ui_lang.no_change,!1)});$("#sendRequests").click(function(){sendRequestToFriends()});
function fb_login(a){FB.login(function(a){console.log("Logging you in..")},{scope:a})}function removeLoading(){$("div.progress").remove();$("div.part_one").show()}function setLoading(){var a=$("div.part_one");a.hide();a.before('<div class="progress progress-striped active"><div class="bar"></div></div>');$("div.part_one").on("data_fetch",function(a){1>=window.loading_queue?removeLoading():window.loading_queue--})}
FB.getLoginStatus(function(a){"connected"===a.status&&(window.loading_queue=Object.keys(window.active_settings).length,setLoading(),getFriendsData(function(){Plugins.FriendsBirthdays.initBirthdays("div.part_one");Plugins.FriendsBirthdays.getOrderedBirthdays(getSelDate(),"after");Plugins.FriendsBirthdays.displayBirthdays(3);Plugins.FriendsBirthdays.addEventHandlers();$("div.part_one").trigger("data_fetch")}),getEventsData(function(){Plugins.FriendsEvents.initEvents("div.part_one");Plugins.FriendsEvents.getOrderedEvents(getSelDate(),
"after");Plugins.FriendsEvents.displayEvents(3);Plugins.FriendsEvents.addEventHandlers();$("div.part_one").trigger("data_fetch")}),getPhotosData(function(){Plugins.DayPhotos.initPhotos("div.part_two");Plugins.DayPhotos.getOrderedPhotos(getSelDate(),"before");Plugins.DayPhotos.displayPhotos(3);Plugins.DayPhotos.addEventHandlers();$("div.part_one").trigger("data_fetch")}),window.active_settings.hasOwnProperty("publish_stream")&&(Plugins.PublishNotes.initNotes(),$("div.part_one").trigger("data_fetch")),
hide_hidden())});function sendRequestToFriends(){FB.ui({method:"apprequests",message:ui_lang.app_advert})}jQuery.fn.addDiv=function(a,f,d){$("<div/>",{"class":a,id:d,text:f}).appendTo(this)};Date.prototype.getMonthName=function(){return ui_lang.month_names[this.getMonth()]};
function getFriendsData(a){if(window.active_settings.hasOwnProperty("friends_birthday")){var f=(new Date).getTime(),d=(f-$.totalStorage("recived_friends"))/1E3;!$.totalStorage("friends_data")||3600<d||$.totalStorage("friends_data").error?FB.api("/me/friends",{fields:"name,id,location,birthday,picture"},function(b){$.totalStorage("friends_data",b.data);$.totalStorage("recived_friends",f);a()}):a()}}
function getEventsData(a){if(window.active_settings.hasOwnProperty("friends_events")){var f=(new Date).getTime(),d=(f-$.totalStorage("recived_events"))/1E3;!$.totalStorage("events_data")||$.totalStorage("events_data").error||3600<d?FB.api({method:"fql.query",query:"SELECT eid, name, start_time, end_time, location, pic_small FROM event WHERE eid IN (SELECT eid FROM event_member WHERE uid IN (SELECT uid2 FROM friend WHERE uid1 = me()))"},function(b){$.totalStorage("events_data",b);$.totalStorage("recived_events",
f);a()}):a()}}
function getPhotosData(a){if(window.active_settings.hasOwnProperty("user_photos")){var f=(new Date).getTime(),d=(f-$.totalStorage("recived_photos"))/1E3;!$.totalStorage("photos_data")||$.totalStorage("photos_data").error||360<d?FB.api({method:"fql.query",query:"SELECT created, src, src_big, link, caption FROM photo WHERE aid IN (SELECT aid FROM album WHERE owner=me()) OR pid IN (SELECT pid FROM photo_tag WHERE subject = me())"},function(b){$.totalStorage("photos_data",b);$.totalStorage("recived_photos",f);
a()}):a()}}var Plugins={};
Plugins.FriendsBirthdays=function(a){function f(a,e){a=a.toString();var c=a.match(/[0-9]{2}/g),g=c[0],c=c[1];return new Date(e.getFullYear(),g-1,c)}var d=[];return{initBirthdays:function(b){a(b).addDiv("span6","","friends_birthdays");a("div#friends_birthdays").addDiv("well");a("div#friends_birthdays").children(".well").first().html("<h3>"+ui_lang.birthdays+'</h3><div class="plugin_buttons"><a class="btn btn-mini bt_hide" href="#result_birthdays" title="hide"><i class="icon-chevron-up"></i></a><a class="btn btn-mini" id="bd_before" href="javascript:void(0)">'+ui_lang.past+
'</a><a class="btn btn-mini disabled" id="bd_after" href="javascript:void(0)">'+ui_lang.upcoming+"</a></div>");a("div#friends_birthdays").children(".well").first().addDiv("","","result_birthdays");a("div#friends_birthdays").children(".well").append('<div class="plugin_buttons bottom"><a class="btn btn-mini" id="bd_more" href="javascript:void(0)">'+ui_lang.show_more+'</a></div><div class="clearfix"></div>')},getOrderedBirthdays:function(b,e){var c=a.totalStorage("friends_data"),g=b?b:new Date;g.setHours(0,
0,0,0);var h=[],k=[];for(i in c)void 0!=c[i].birthday&&(b=f(c[i].birthday,g),c[i].birthday_date=b,"after"==e?b>=g?(b.getTime()==g.getTime()&&(c[i].has_bd=!0),h.push(c[i])):k.push(c[i]):b<g?(b.getTime()==g.getTime()&&(c[i].has_bd=!0),h.push(c[i])):k.push(c[i]));c="after"==e?function(a,g){return a.birthday_date-g.birthday_date}:function(a,g){return g.birthday_date-a.birthday_date};h=h.sort(c);k=k.sort(c);d=h=h.concat(k)},displayBirthdays:function(b){b=d.splice(0,b);var e="",c="",g;for(g in b)b[g].hasOwnProperty("has_bd")?
(e+="<div class='birthday is_today'>",c="<i class='icon-gift'></i>"):(e+="<div class='birthday'>",c=""),e+="<div class='img_holder'><a href='https://facebook.com/"+b[g].id+"' title='"+b[g].name+"' target='_blank'><img src='"+b[g].picture.data.url+"'/></a></div>",e+="<span class='name'>"+b[g].name+c+"</span>",e+="<span class='date'>"+b[g].birthday_date.getMonthName()+" "+b[g].birthday_date.getDate()+"</span>",e+="</div>";a("div#result_birthdays").append(e)},addEventHandlers:function(){a("div.cal-cell").click(function(){a("div#result_birthdays").empty();
Plugins.FriendsBirthdays.getOrderedBirthdays(getSelDate(),"after");Plugins.FriendsBirthdays.displayBirthdays(3);a("#bd_after").addClass("disabled");a("#bd_before").removeClass("disabled")});a("#bd_more").on("click",function(){Plugins.FriendsBirthdays.displayBirthdays(3)});a("#bd_after").on("click",function(){a("div#result_birthdays").empty();Plugins.FriendsBirthdays.getOrderedBirthdays(getSelDate(),"after");Plugins.FriendsBirthdays.displayBirthdays(3);a(this).addClass("disabled");a("#bd_before").removeClass("disabled")});
a("#bd_before").on("click",function(){a("div#result_birthdays").empty();Plugins.FriendsBirthdays.getOrderedBirthdays(getSelDate(),"before");Plugins.FriendsBirthdays.displayBirthdays(3);a(this).addClass("disabled");a("#bd_after").removeClass("disabled")})}}}(jQuery);
Plugins.FriendsEvents=function(a){function f(a,b){function c(a){return 10>a?"0"+a:a}var e=b.getDate()!=a.getDate()&&0!=b.getTime()?" - "+b.getMonthName()+" "+b.getDate()+" "+b.getHours()+":"+c(b.getMinutes()):"";return a.getMonthName()+" "+a.getDate()+" "+a.getHours()+":"+c(a.getMinutes())+e}function d(b){var c="",e="",d;for(d in b)b[d].hasOwnProperty("is_today")?(c+="<div class='event is_today'>",e="<i class='icon-bell'></i>"):(c+="<div class='event'>",e=""),c+="<div class='img_holder'><a href='https://facebook.com/"+
b[d].eid+"' title='"+b[d].name+"' target='_blank'><img src='"+b[d].pic_small+"'/></a></div>",c+="<span class='name'>"+b[d].name+e+"</span>",c+="<span class='date'><i class='icon-time'></i>"+f(new Date(b[d].start_time),new Date(b[d].end_time))+"</span>",b[d].location&&(c+="<span class='place'><i class='icon-map-marker'></i>"+b[d].location+"</span>"),c+="<div class='clearfix'></div></div>";a("div#result_events").append(c)}function b(){var b=[],e=a("#evt_search_field").val().toLowerCase();if(2<e.length){for(var f in c){var l=
c[f].name.toLowerCase().indexOf(e);res_loc=-1;c[f].location&&(res_loc=c[f].location.toLowerCase().indexOf(e));-1==l&&-1==res_loc||b.push(c[f])}a("div#result_events").empty();a("#evt_before").removeClass("disabled");a("#evt_after").removeClass("disabled");d(b)}}var e=[],c=[];return{initEvents:function(b){a(b).addDiv("span6","","friends_events");a("div#friends_events").addDiv("well");a("div#friends_events").children(".well").first().html("<h3>"+ui_lang.events+'</h3><div class="plugin_buttons"><a class="btn btn-mini bt_hide" href="#result_events" title="hide"><i class="icon-chevron-up"></i></a><a class="btn btn-mini" id="evt_search" href="javascript:void(0)"><i class="icon-search"></i></a><a class="btn btn-mini" id="evt_before" href="javascript:void(0)">'+
ui_lang.past+'</a><a class="btn btn-mini disabled" id="evt_after" href="javascript:void(0)">'+ui_lang.upcoming+"</a></div>");a("div#friends_events").children(".well").first().addDiv("","","result_events");a("div#friends_events").children(".well").append('<div class="plugin_buttons bottom"><a class="btn btn-mini" id="evt_more" href="javascript:void(0)">'+ui_lang.show_more+'</a></div><div class="clearfix"></div>')},getOrderedEvents:function(b,d){c=a.totalStorage("events_data");var f=b?b:new Date;f.setHours(0,
0,0,0);var l=[],n=0;for(i in c){if(500<n)break;else n++;var m=new Date(c[i].start_time);"after"==d?m>=f&&(m.setHours(0,0,0,0)==f.getTime()&&(c[i].is_today=!0),l.push(c[i])):m<f&&(m.setHours(0,0,0,0)==f.getTime()&&(c[i].is_today=!0),l.push(c[i]))}e=l="after"==d?l.sort(function(a,b){return new Date(a.start_time)-new Date(b.start_time)}):l.sort(function(a,b){return new Date(b.start_time)-new Date(a.start_time)})},displayEvents:function(a){a=e.splice(0,a);d(a)},addEventHandlers:function(){a("div.cal-cell").click(function(){a("div#result_events").empty();
Plugins.FriendsEvents.getOrderedEvents(getSelDate(),"after");Plugins.FriendsEvents.displayEvents(3);a("#evt_after").addClass("disabled");a("#evt_before").removeClass("disabled")});a("#evt_more").on("click",function(){Plugins.FriendsEvents.displayEvents(3)});a("#evt_after").on("click",function(){a("div#result_events").empty();Plugins.FriendsEvents.getOrderedEvents(getSelDate(),"after");Plugins.FriendsEvents.displayEvents(3);a(this).addClass("disabled");a("#evt_before").removeClass("disabled")});a("#evt_before").on("click",
function(){a("div#result_events").empty();Plugins.FriendsEvents.getOrderedEvents(getSelDate(),"before");Plugins.FriendsEvents.displayEvents(3);a(this).addClass("disabled");a("#evt_after").removeClass("disabled")});a("#evt_search").live("click",function(b){b.preventDefault();a(this).popover("toggle");a("#evt_search_field").focus()});a("#evt_search").popover({trigger:"manual",html:!0,content:function(){return'<div class="arrow"></div><div class="popover-inner small"><div class="popover-add"><div class="input-append"><input class="span2" id="evt_search_field" type="text"><button class="btn" id="evt_find" type="button">'+
ui_lang.find+"</button></div></div></div>"},placement:"bottom"});a("#evt_find").live("click",function(){b();a("#evt_search").popover("hide")});a("#evt_search_field").live("keypress",function(c){13==c.which&&(b(),a("#evt_search").popover("hide"))})}}}(jQuery);
Plugins.PublishNotes=function(a){return{initNotes:function(){a("#day-events").on("data_fetch",function(f){a("div.desc-field").before('<button class="btn add-fb-note" title="'+ui_lang.fb_add_note+'">f</button>')});a(".add-fb-note").live("click",function(){var f={},d=a(this).parents(".event-item");f.subject=d.find("h3.event-name").html();f.message=d.find(".desc-field").html().trim();d={};d.date=a("#active-date").html();d.month=a(".month-name").html();d.year=a(".year").html();f.subject=f.subject.concat(" (",
d.date,d.month,", ",d.year,")");console.log(f);f.subject&&FB.api("/me/notes","post",f,function(b){!b||b.error?a("div#event-container").response(ui_lang.fb_note_failed,!1):a("div#event-container").response(ui_lang.fb_note_added,!0)})})}}}(jQuery);
Plugins.DayPhotos=function(a){var f=[],d=[];return{initPhotos:function(b){a(b).addDiv("span12","","user_photos");a("div#user_photos").addDiv("well");a("div#user_photos").children(".well").first().html("<h3>"+ui_lang.day_photos+'</h3><div class="plugin_buttons"><a class="btn btn-mini bt_hide" href="#result_photos" title="hide"><i class="icon-chevron-up"></i></a><a class="btn btn-mini disabled" id="photos_before" href="javascript:void(0)">'+ui_lang.past+'</a><a class="btn btn-mini" id="photos_after" href="javascript:void(0)">'+
ui_lang.upcoming+"</a></div>");a("div#user_photos").children(".well").first().addDiv("","","result_photos");a("div#user_photos").children(".well").append('<div class="plugin_buttons bottom"><a class="btn btn-mini" id="photo_more" href="javascript:void(0)">'+ui_lang.show_more+'</a></div><div class="clearfix"></div>');a("#photos_after").hide();a("div#user_photos").append("<div id='photoModal' class='modal hide fade' tabindex='-1' role='dialog' aria-labelledby='accessModalLabel' aria-hidden='true'><div class='modal-header'><h3 id='photoModalHeader'></h3><button type='button' class='close' data-dismiss='modal' aria-hidden='true'>\u00d7</button></div><div class='modal-body'></div></div>")},
getOrderedPhotos:function(b,e){d=a.totalStorage("photos_data");var c=b?b:new Date,g=0,h=[];for(i in d){var k=new Date(1E3*d[i].created);k.setHours(0,0,0,0)==c.setHours(0,0,0,0)&&(d[i].is_today=!0);k-=864E5;if(500<g)break;else g++;"after"==e?k>c&&h.push(d[i]):k<c&&h.push(d[i])}f=h="after"==e?h.sort(function(a,b){return new Date(1E3*a.created)-new Date(1E3*b.created)}):h.sort(function(a,b){return new Date(1E3*b.created)-new Date(1E3*a.created)})},displayPhotos:function(b){b=f.splice(0,b);var e="",c=
"";if(0==b.length)e+="<p>No photos present!</p>",a("#photo_more").hide();else{for(var d in b)c=b[d].hasOwnProperty("is_today")?" is_today":"",e+="<div class='photo'>",e+="<div class='img_holder"+c+"'><a href='"+b[d].link+"' title='"+b[d].caption+"' target='_blank'><div class='img_container'><img src='"+b[d].src+"'/></div></a>",e+="<a class='btn btn-mini zoom-in' href='javascript:void(0)' data-image='"+b[d].src_big+"' data-caption='"+b[d].caption+"'><i class='icon-zoom-in'></i></a></div>",e+="</div>";
a("#photo_more").show()}a("div#result_photos").append(e)},addEventHandlers:function(){a("div.cal-cell").click(function(){a("div#result_photos").empty();Plugins.DayPhotos.getOrderedPhotos(getSelDate(),"before");Plugins.DayPhotos.displayPhotos(3);a("#photos_before").addClass("disabled");a("#photos_after").removeClass("disabled");getSelDate()<(new Date).setHours(0,0,0,0)?a("#photos_after").show():a("#photos_after").hide()});a("#photo_more").on("click",function(){Plugins.DayPhotos.displayPhotos(3)});
a("#photos_after").on("click",function(){a("div#result_photos").empty();Plugins.DayPhotos.getOrderedPhotos(getSelDate(),"after");Plugins.DayPhotos.displayPhotos(3);a(this).addClass("disabled");a("#photos_before").removeClass("disabled")});a("#photos_before").on("click",function(){a("div#result_photos").empty();Plugins.DayPhotos.getOrderedPhotos(getSelDate(),"before");Plugins.DayPhotos.displayPhotos(3);a(this).addClass("disabled");a("#photos_after").removeClass("disabled")});a("div.img_holder").live({mouseenter:function(){a(this).find("a.zoom-in").css("visibility",
"visible")},mouseleave:function(){a(this).find("a.zoom-in").css("visibility","hidden")}});a("a.zoom-in").live("click",function(){var b=a(this).attr("data-caption");b||(b="&nbsp;");var d="<img src='"+a(this).attr("data-image")+"' title='"+b+"' class='modal-img'/>";a("#photoModalHeader").html(b);a("#photoModal > .modal-body").html(d);a("#photoModal > .modal-body").append('<div class="progress progress-striped active photo"><div class="bar"></div></div>');a("#photoModal").modal("show");a(".modal-img").load(function(){a("div.progress").remove();
a(this).show()})})}}}(jQuery);
